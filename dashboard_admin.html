<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Administrativo - Campus Universitario</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    :root {
      --navy-900: #0f172a;
      --navy-800: #1e293b;
      --navy-700: #1e3a8a;
      --navy-600: #1d4ed8;
      --navy-500: #2563eb;
      --navy-400: #3b82f6;
      --navy-300: #60a5fa;
      --navy-200: #93c5fd;
      --navy-100: #bfdbfe;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border-radius: 16px;
      --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      --transition: all 0.3s ease;
    }

    body {
      background: linear-gradient(135deg, var(--navy-900) 0%, var(--navy-800) 100%);
      min-height: 100vh;
      overflow-x: hidden;
      color: white;
    }

    .dashboard {
      display: flex;
      min-height: 100vh;
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, var(--navy-900) 0%, var(--navy-800) 100%);
      box-shadow: 5px 0 25px rgba(0, 0, 0, 0.4);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      transition: var(--transition);
      z-index: 1000;
      border-right: 2px solid var(--navy-500);
    }

    .sidebar-header {
      padding: 30px 20px 25px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
      text-align: center;
      background: rgba(15, 23, 42, 0.9);
    }

    .sidebar-header h1 {
      color: var(--navy-300);
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
      text-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }

    .sidebar-header .subtitle {
      color: var(--navy-400);
      font-size: 13px;
      margin-top: 5px;
      letter-spacing: 1px;
    }

    .user-profile {
      padding: 20px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(30, 58, 138, 0.3);
    }

    .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--navy-500), var(--navy-600));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
      border: 3px solid var(--navy-400);
    }

    .user-info h3 {
      font-size: 18px;
      color: white;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .user-info p {
      font-size: 14px;
      color: var(--navy-300);
      margin-bottom: 5px;
    }

    .user-badge {
      display: inline-block;
      padding: 5px 12px;
      background: rgba(168, 85, 247, 0.2);
      border: 1px solid rgba(168, 85, 247, 0.4);
      color: #c084fc;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-top: 3px;
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .menu-section {
      margin-bottom: 15px;
    }

    .menu-section-title {
      padding: 12px 25px;
      color: var(--navy-400);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-left: 3px solid var(--navy-500);
      margin: 0 15px 10px;
    }

    .menu-item {
      padding: 14px 25px;
      display: flex;
      align-items: center;
      gap: 15px;
      color: var(--navy-200);
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      transition: var(--transition);
      border-left: 4px solid transparent;
      cursor: pointer;
      position: relative;
    }

    .menu-item:hover {
      background: rgba(37, 99, 235, 0.15);
      color: white;
      border-left: 4px solid var(--navy-500);
    }

    .menu-item.active {
      background: rgba(37, 99, 235, 0.25);
      color: white;
      border-left: 4px solid var(--navy-400);
      box-shadow: inset 0 0 15px rgba(37, 99, 235, 0.3);
    }

    .menu-item i {
      width: 28px;
      font-size: 20px;
      color: var(--navy-400);
    }

    .menu-item.active i {
      color: var(--navy-300);
    }

    .menu-item .badge {
      margin-left: auto;
      padding: 4px 10px;
      background: var(--danger);
      color: white;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 700;
      min-width: 24px;
      text-align: center;
    }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      flex: 1;
      margin-left: 280px;
      transition: var(--transition);
    }

    .header {
      background: linear-gradient(90deg, var(--navy-900), var(--navy-800));
      padding: 20px 40px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 900;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--navy-600);
    }

    .header-left h1 {
      font-size: 28px;
      color: white;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logout-btn {
      background: linear-gradient(90deg, var(--danger), #dc2626);
      color: white;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }

    .logout-btn:hover {
      background: linear-gradient(90deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .container {
      padding: 40px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .page-title {
      margin-bottom: 35px;
    }

    .page-title h2 {
      font-size: 36px;
      color: white;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(90deg, var(--navy-200), var(--navy-300), var(--navy-400));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-title p {
      color: var(--navy-300);
      font-size: 18px;
      line-height: 1.6;
    }

    /* ========== STATS CARDS ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(145deg, var(--navy-800), var(--navy-900));
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      border: 1px solid rgba(59, 130, 246, 0.2);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--navy-500), var(--navy-400));
    }

    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
      border-color: rgba(59, 130, 246, 0.4);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .stat-card-icon {
      font-size: 40px;
      padding: 15px;
      border-radius: 20px;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(59, 130, 246, 0.15);
      color: var(--navy-300);
      border: 2px solid rgba(59, 130, 246, 0.3);
    }

    .stat-card-value {
      font-size: 42px;
      font-weight: 800;
      color: white;
      margin-bottom: 8px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .stat-card-label {
      color: var(--navy-300);
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* ========== ACTION BAR ========== */
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      gap: 20px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      max-width: 400px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 14px 20px 14px 50px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 14px;
      font-size: 16px;
      transition: var(--transition);
      background: rgba(15, 23, 42, 0.7);
      color: white;
      font-weight: 500;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--navy-400);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }

    .search-box i {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--navy-400);
      font-size: 18px;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--navy-600), var(--navy-700));
      color: white;
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }

    .btn-primary:hover {
      background: linear-gradient(90deg, var(--navy-700), var(--navy-800));
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5);
    }

    .btn-success {
      background: linear-gradient(90deg, var(--success), #059669);
      color: white;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-success:hover {
      background: linear-gradient(90deg, #059669, #047857);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.5);
    }

    .btn-danger {
      background: linear-gradient(90deg, var(--danger), #dc2626);
      color: white;
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .btn-danger:hover {
      background: linear-gradient(90deg, #dc2626, #b91c1c);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.5);
    }

    .btn-secondary {
      background: rgba(100, 116, 139, 0.3);
      color: var(--navy-200);
      border: 2px solid rgba(100, 116, 139, 0.5);
    }

    .btn-secondary:hover {
      background: rgba(100, 116, 139, 0.5);
      border-color: rgba(100, 116, 139, 0.7);
    }

    /* ========== CARD & TABLE ========== */
    .card {
      background: linear-gradient(145deg, var(--navy-800), var(--navy-900));
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      border: 1px solid rgba(59, 130, 246, 0.2);
      transition: var(--transition);
      margin-bottom: 30px;
    }

    .card:hover {
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
      border-color: rgba(59, 130, 246, 0.4);
    }

    .data-table {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table thead {
      background: rgba(30, 58, 138, 0.4);
    }

    table th {
      padding: 18px 20px;
      text-align: left;
      font-weight: 700;
      color: var(--navy-200);
      font-size: 15px;
      border-bottom: 2px solid var(--navy-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    table td {
      padding: 18px 20px;
      color: var(--navy-100);
      font-size: 15px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    }

    table tbody tr {
      transition: var(--transition);
    }

    table tbody tr:hover {
      background: rgba(30, 58, 138, 0.2);
    }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .table-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--navy-500), var(--navy-600));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      border: 2px solid var(--navy-400);
      font-size: 16px;
    }

    .user-details h4 {
      font-size: 15px;
      font-weight: 600;
      color: white;
      margin-bottom: 4px;
    }

    .user-details p {
      font-size: 13px;
      color: var(--navy-300);
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-admin {
      background: rgba(168, 85, 247, 0.15);
      color: #c084fc;
      border: 1px solid rgba(168, 85, 247, 0.3);
    }

    .badge-audiovisual {
      background: rgba(99, 102, 241, 0.15);
      color: #818cf8;
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    .badge-integral {
      background: rgba(6, 182, 212, 0.15);
      color: #22d3ee;
      border: 1px solid rgba(6, 182, 212, 0.3);
    }

    .badge-sistemas {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .badge-activo {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .badge-inactivo {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .badge-aprobado {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .badge-enviado {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .badge-borrador {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .badge-observado {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid rgba(59, 130, 246, 0.3);
      background: rgba(15, 23, 42, 0.5);
      color: var(--navy-300);
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-icon:hover {
      background: rgba(59, 130, 246, 0.2);
      border-color: var(--navy-400);
      color: white;
      transform: translateY(-2px);
    }

    .btn-icon.edit:hover {
      background: rgba(59, 130, 246, 0.2);
      border-color: var(--navy-400);
    }

    .btn-icon.delete:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--danger);
      color: var(--danger);
    }

    /* ========== MODAL ========== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(145deg, var(--navy-800), var(--navy-900));
      border-radius: var(--border-radius);
      max-width: 700px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(59, 130, 246, 0.3);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 30px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 58, 138, 0.3);
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn-close {
      background: none;
      border: none;
      color: var(--navy-300);
      cursor: pointer;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .btn-close:hover {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .modal-body {
      padding: 35px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      color: white;
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group label i {
      color: var(--navy-400);
      font-size: 18px;
    }

    .form-control {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 14px;
      font-size: 16px;
      transition: var(--transition);
      background: rgba(15, 23, 42, 0.7);
      color: white;
      font-weight: 500;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--navy-400);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
      background: rgba(15, 23, 42, 0.9);
    }

    .form-control option {
      background: var(--navy-800);
      color: white;
    }

    textarea.form-control {
      min-height: 120px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .file-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 20px;
      border: 2px dashed rgba(59, 130, 246, 0.3);
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.5);
      color: var(--navy-300);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-upload-label:hover {
      border-color: var(--navy-400);
      background: rgba(30, 58, 138, 0.3);
      color: white;
    }

    .file-preview {
      margin-top: 15px;
      display: none;
    }

    .file-preview.active {
      display: block;
    }

    .file-preview img {
      max-width: 100%;
      border-radius: 12px;
      border: 2px solid rgba(59, 130, 246, 0.3);
    }

    .modal-footer {
      padding: 25px 35px;
      border-top: 2px solid rgba(59, 130, 246, 0.2);
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      background: rgba(15, 23, 42, 0.5);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--navy-500);
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--navy-300);
    }

    .empty-state i {
      font-size: 64px;
      color: var(--navy-500);
      margin-bottom: 25px;
      opacity: 0.7;
    }

    .empty-state h3 {
      font-size: 24px;
      color: white;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .empty-state p {
      font-size: 16px;
      max-width: 500px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 900px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .container {
        padding: 25px 15px;
      }
      .header {
        padding: 15px 20px;
      }
      .action-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .search-box {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>⚙️ Panel Administrativo</h1>
        <div class="subtitle">Sistema de Gestión del Campus</div>
      </div>

      <div class="user-profile" id="userProfile">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-info">
          <h3 id="userName">Cargando...</h3>
          <p id="userEmail">admin@campus.edu</p>
          <span class="user-badge">ADMINISTRADOR</span>
        </div>
      </div>

      <div class="sidebar-menu">
        <div class="menu-section">
          <div class="menu-section-title">Panel de Control</div>
          <div class="menu-item active" data-section="dashboard">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </div>
        </div>

        <div class="menu-section">
          <div class="menu-section-title">Gestión</div>
          <div class="menu-item" data-section="usuarios">
            <i class="fas fa-users"></i>
            <span>Usuarios</span>
          </div>
          <div class="menu-item" data-section="actividades">
            <i class="fas fa-tasks"></i>
            <span>Actividades</span>
          </div>
        </div>

        <div class="menu-section">
          <div class="menu-section-title">Reportes</div>
          <div class="menu-item" data-section="estadisticas">
            <i class="fas fa-chart-bar"></i>
            <span>Estadísticas</span>
          </div>
        </div>

        <div class="menu-section">
          <div class="menu-section-title">Sistema</div>
          <div class="menu-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Cerrar Sesión</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <h1 id="pageTitle">Dashboard Administrativo</h1>
        </div>
        <div class="header-right">
          <button class="logout-btn" id="logoutBtnMobile">
            <i class="fas fa-sign-out-alt"></i> Salir
          </button>
        </div>
      </header>

      <div class="container">
        <!-- CONTENT SECTIONS -->
        <div id="content-dashboard">
          <div class="page-title">
            <h2>Dashboard - Panel de Control</h2>
            <p>Resumen general del sistema de gestión del campus</p>
          </div>

          <div class="stats-grid" id="statsGrid">
            <!-- Stats cards will be populated here -->
          </div>

          <div class="card">
            <div class="data-table">
              <h3 style="padding: 25px 25px 0; color: white; font-size: 22px;">
                <i class="fas fa-chart-line" style="color: var(--navy-400); margin-right: 10px;"></i>
                Actividades Recientes
              </h3>
              <div id="recentActivitiesTable" style="padding: 25px;">
                <!-- Recent activities will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <div id="content-usuarios" style="display: none;">
          <div class="page-title">
            <h2>Gestión de Usuarios</h2>
            <p>Administra el personal del campus y sus roles</p>
          </div>

          <div class="action-bar">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="searchUsers" placeholder="Buscar usuarios...">
            </div>
            <button class="btn btn-primary" onclick="openUserModal('new')">
              <i class="fas fa-user-plus"></i> Nuevo Usuario
            </button>
          </div>

          <div class="card">
            <div class="data-table">
              <table id="usersTable">
                <thead>
                  <tr>
                    <th>Usuario</th>
                    <th>Rol</th>
                    <th>Área</th>
                    <th>Teléfono</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Users will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="content-actividades" style="display: none;">
          <div class="page-title">
            <h2>Gestión de Actividades</h2>
            <p>Administra todas las actividades de mantenimiento</p>
          </div>

          <div class="action-bar">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="searchActivities" placeholder="Buscar actividades...">
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-success" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Exportar Excel
              </button>
              <button class="btn btn-primary" onclick="openActivityModal('new')">
                <i class="fas fa-plus"></i> Nueva Actividad
              </button>
            </div>
          </div>

          <div class="card">
            <div class="data-table">
              <table id="activitiesTable">
                <thead>
                  <tr>
                    <th>Actividad</th>
                    <th>Usuario</th>
                    <th>Categoría</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Evidencia</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="activitiesTableBody">
                  <!-- Activities will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="content-estadisticas" style="display: none;">
          <div class="page-title">
            <h2>Estadísticas del Sistema</h2>
            <p>Análisis detallado de actividades y rendimiento</p>
          </div>

          <div class="stats-grid" id="detailedStats">
            <!-- Detailed stats will be populated here -->
          </div>

          <div class="card">
            <div style="padding: 35px;">
              <h3 style="color: white; font-size: 22px; margin-bottom: 25px;">
                <i class="fas fa-chart-pie" style="color: var(--navy-400); margin-right: 10px;"></i>
                Distribución por Categoría
              </h3>
              <div id="categoryDistribution">
                <!-- Category distribution will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- USER MODAL -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="userModalTitle">
          <i class="fas fa-user-edit"></i> Nuevo Usuario
        </h3>
        <button class="btn-close" onclick="closeUserModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <input type="hidden" id="userId">
          
          <div class="form-group">
            <label><i class="fas fa-user"></i> Nombre Completo *</label>
            <input type="text" class="form-control" id="userFullName" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-at"></i> Usuario *</label>
              <input type="text" class="form-control" id="userUsername" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-envelope"></i> Correo *</label>
              <input type="email" class="form-control" id="userEmail" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user-tag"></i> Rol *</label>
              <select class="form-control" id="userRole" required>
                <option value="">Seleccionar...</option>
                <option value="administrador">Administrador</option>
                <option value="tecnico_audiovisual">Técnico Audiovisual</option>
                <option value="tecnico_integral">Técnico Integral</option>
                <option value="tecnico_sistemas">Técnico de Sistemas Esenciales</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-phone"></i> Teléfono</label>
              <input type="tel" class="form-control" id="userPhone">
            </div>
            <div class="form-group">
              <label><i class="fas fa-briefcase"></i> Cargo</label>
              <input type="text" class="form-control" id="userCargo">
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-lock"></i> Contraseña <span id="passwordLabel">*</span></label>
            <input type="password" class="form-control" id="userPassword">
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="userActive" checked>
              <label style="margin: 0;">Usuario Activo</label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveUser()">
          <i class="fas fa-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- ACTIVITY MODAL -->
  <div class="modal" id="activityModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="activityModalTitle">
          <i class="fas fa-tasks"></i> Nueva Actividad
        </h3>
        <button class="btn-close" onclick="closeActivityModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="activityForm">
          <input type="hidden" id="activityId">
          
          <div class="form-group">
            <label><i class="fas fa-heading"></i> Título *</label>
            <input type="text" class="form-control" id="activityTitle" required>
          </div>

          <div class="form-group">
            <label><i class="fas fa-align-left"></i> Descripción *</label>
            <textarea class="form-control" id="activityDescription" required></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user"></i> Usuario *</label>
              <select class="form-control" id="activityUser" required>
                <!-- Users will be populated dynamically -->
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-layer-group"></i> Categoría *</label>
              <select class="form-control" id="activityCategory" required>
                <!-- Categories will be populated dynamically -->
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-wrench"></i> Tipo Mantenimiento *</label>
              <select class="form-control" id="activityType" required>
                <!-- Types will be populated dynamically -->
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-building"></i> Área *</label>
              <select class="form-control" id="activityArea" required>
                <!-- Areas will be populated dynamically -->
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-calendar"></i> Fecha *</label>
              <input type="date" class="form-control" id="activityDate" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-clock"></i> Duración (horas) *</label>
              <input type="number" class="form-control" id="activityDuration" step="0.5" min="0" required>
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-map-marker-alt"></i> Lugar</label>
            <input type="text" class="form-control" id="activityLocation">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-flag"></i> Estado *</label>
              <select class="form-control" id="activityStatus" required>
                <option value="borrador">Borrador</option>
                <option value="enviado">Enviado</option>
                <option value="aprobado">Aprobado</option>
                <option value="observado">Observado</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-exclamation-circle"></i> Prioridad *</label>
              <select class="form-control" id="activityPriority" required>
                <option value="baja">Baja</option>
                <option value="media">Media</option>
                <option value="alta">Alta</option>
                <option value="critica">Crítica</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-camera"></i> Evidencia Fotográfica</label>
            <div class="file-upload">
              <input type="file" id="activityEvidence" accept="image/*" onchange="previewImage(this)">
              <label class="file-upload-label" for="activityEvidence">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Seleccionar imagen</span>
              </label>
            </div>
            <div class="file-preview" id="imagePreview">
              <img id="previewImg" alt="Preview">
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-comment"></i> Observaciones del Supervisor</label>
            <textarea class="form-control" id="activityObservation"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeActivityModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveActivity()">
          <i class="fas fa-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>

  <script>
    const DB_PATH = 'data2.json';
    let DATABASE = null;
    let currentAdmin = null;
    let currentEditId = null;
    let uploadedImage = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Verificar sesión válida
      const sessionData = sessionStorage.getItem('session_SAC');
      if (!sessionData) {
        // No hay sesión, redirigir al login
        window.location.replace('index.html');
        return;
      }

      try {
        const session = JSON.parse(sessionData);
        const ahora = new Date();
        const expira = new Date(session.expira);
        
        // Verificar si la sesión expiró
        if (ahora >= expira) {
          sessionStorage.removeItem('session_SAC');
          localStorage.removeItem('session_SAC_permanent');
          localStorage.setItem('logout_motivo', 'expired');
          window.location.replace('index.html?logout=1');
          return;
        }

        // Verificar que sea administrador
        if (session.rol !== 'administrador') {
          sessionStorage.removeItem('session_SAC');
          localStorage.removeItem('session_SAC_permanent');
          alert('Acceso denegado: Esta página es solo para administradores');
          window.location.replace('index.html');
          return;
        }
      } catch (e) {
        console.error('Error al verificar sesión:', e);
        window.location.replace('index.html');
        return;
      }

      await loadDatabase();
      initAdmin();
      setupEventListeners();
      loadDashboard();

      // Prevenir volver atrás después de cerrar sesión
      window.history.pushState(null, '', window.location.href);
      window.addEventListener('popstate', function() {
        window.history.pushState(null, '', window.location.href);
      });
    });

    async function loadDatabase() {
      try {
        const response = await fetch(DB_PATH);
        if (!response.ok) throw new Error('No se pudo cargar la base de datos');
        DATABASE = await response.json();
        console.log('✅ Base de datos cargada correctamente');
      } catch (error) {
        console.error('❌ Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error al cargar datos',
          text: 'No se pudo cargar la base de datos. Verifica que data2.json esté disponible.',
          background: 'var(--navy-800)',
          color: 'white',
          confirmButtonColor: 'var(--danger)'
        });
      }
    }

    function initAdmin() {
      currentAdmin = DATABASE.usuarios.find(u => u.rol === 'administrador');
      if (currentAdmin) {
        const initials = currentAdmin.nombre_completo.split(' ').map(n => n[0]).join('').substring(0, 2);
        document.getElementById('userName').textContent = currentAdmin.nombre_completo;
        document.getElementById('userEmail').textContent = currentAdmin.correo;
        document.getElementById('userAvatar').textContent = initials;
      }
      //populateSelects();
    }

    function setupEventListeners() {
      // Menu navigation
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
          const section = this.getAttribute('data-section');
          if (section) {
            navigateToSection(section);
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
          }
        });
      });

      // Logout buttons
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('logoutBtnMobile').addEventListener('click', logout);

      // Search filters
      document.getElementById('searchUsers')?.addEventListener('input', filterUsers);
      document.getElementById('searchActivities')?.addEventListener('input', filterActivities);
    }

    function navigateToSection(section) {
      // Hide all sections
      document.querySelectorAll('[id^="content-"]').forEach(el => el.style.display = 'none');
      
      // Show selected section
      document.getElementById(`content-${section}`).style.display = 'block';
      
      // Update page title
      const titles = {
        'dashboard': 'Dashboard Administrativo',
        'usuarios': 'Gestión de Usuarios',
        'actividades': 'Gestión de Actividades',
        'estadisticas': 'Estadísticas del Sistema'
      };
      document.getElementById('pageTitle').textContent = titles[section] || 'Panel Administrativo';
      
      // Load section data
      switch(section) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'usuarios':
          loadUsers();
          break;
        case 'actividades':
          loadActivities();
          break;
        case 'estadisticas':
          loadStatistics();
          break;
      }
    }

   // function populateSelects() {
      // Populate areas
     // const areaSelects = [document.getElementById('userArea'), document.getElementById('activityArea')];
      //areaSelects.forEach(select => {
        //if (select) {
          //select.innerHTML = '<option value="">Seleccionar...</option>';
          //DATABASE.areas.forEach(area => {
            //select.innerHTML += `<option value="${area.id}">${area.nombre}</option>`;
          //});
        //}
     // });

      // Populate users for activities
    //   const userSelect = document.getElementById('activityUser');
    //   if (userSelect) {
    //     userSelect.innerHTML = '<option value="">Seleccionar...</option>';
    //     DATABASE.usuarios.forEach(user => {
    //       userSelect.innerHTML += `<option value="${user.id}">${user.nombre_completo} (${user.rol})</option>`;
    //     });
    //   }

    //   // Populate categories
    //   const categorySelect = document.getElementById('activityCategory');
    //   if (categorySelect) {
    //     categorySelect.innerHTML = '<option value="">Seleccionar...</option>';
    //     DATABASE.categorias_mantenimiento.forEach(cat => {
    //       categorySelect.innerHTML += `<option value="${cat.id}">${cat.nombre}</option>`;
    //     });
    //   }

    //   // Populate maintenance types
    //   const typeSelect = document.getElementById('activityType');
    //   if (typeSelect) {
    //     typeSelect.innerHTML = '<option value="">Seleccionar...</option>';
    //     DATABASE.tipos_mantenimiento.forEach(tipo => {
    //       typeSelect.innerHTML += `<option value="${tipo.id}">${tipo.nombre}</option>`;
    //     });
    //   }
    // }

    function loadDashboard() {
      const totalUsers = DATABASE.usuarios.length;
      const totalActivities = DATABASE.actividades.length;
      const pendingActivities = DATABASE.actividades.filter(a => a.estado === 'enviado').length;
      const completedActivities = DATABASE.actividades.filter(a => a.estado === 'aprobado').length;

      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
          <div class="stat-card-header">
            <div>
              <div class="stat-card-value">${totalUsers}</div>
              <div class="stat-card-label">Total Usuarios</div>
            </div>
            <div class="stat-card-icon">
              <i class="fas fa-users"></i>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div>
              <div class="stat-card-value">${totalActivities}</div>
              <div class="stat-card-label">Total Actividades</div>
            </div>
            <div class="stat-card-icon">
              <i class="fas fa-tasks"></i>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div>
              <div class="stat-card-value">${pendingActivities}</div>
              <div class="stat-card-label">Pendientes</div>
            </div>
            <div class="stat-card-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div>
              <div class="stat-card-value">${completedActivities}</div>
              <div class="stat-card-label">Completadas</div>
            </div>
            <div class="stat-card-icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
      `;

      // Load recent activities
      const recentActivities = DATABASE.actividades
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 5);

      let html = '<table><thead><tr><th>Actividad</th><th>Usuario</th><th>Fecha</th><th>Estado</th></tr></thead><tbody>';
      recentActivities.forEach(act => {
        const user = DATABASE.usuarios.find(u => u.id === act.usuario_id);
        html += `
          <tr>
            <td><strong style="color: white;">${act.titulo}</strong></td>
            <td>${user ? user.nombre_completo : 'N/A'}</td>
            <td>${act.fecha_actividad}</td>
            <td><span class="badge badge-${act.estado}">${act.estado}</span></td>
          </tr>
        `;
      });
      html += '</tbody></table>';
      document.getElementById('recentActivitiesTable').innerHTML = html;
    }

    function loadUsers() {
      renderUsersTable();
    }

    function renderUsersTable() {
      const searchTerm = document.getElementById('searchUsers')?.value.toLowerCase() || '';
      const filteredUsers = DATABASE.usuarios.filter(user =>
        user.nombre_completo.toLowerCase().includes(searchTerm) ||
        user.correo.toLowerCase().includes(searchTerm) ||
        user.rol.toLowerCase().includes(searchTerm)
      );

      let html = '';
      filteredUsers.forEach(user => {
        const area = DATABASE.areas.find(a => a.id === user.area_id);
        const initials = user.nombre_completo.split(' ').map(n => n[0]).join('').substring(0, 2);
        const roleBadge = getRoleBadge(user.rol);

        html += `
          <tr>
            <td>
              <div class="user-cell">
                <div class="table-avatar">${initials}</div>
                <div class="user-details">
                  <h4>${user.nombre_completo}</h4>
                  <p>${user.correo}</p>
                </div>
              </div>
            </td>
            <td><span class="badge ${roleBadge.class}">${roleBadge.text}</span></td>
            <td>${area ? area.nombre : 'Sin área'}</td>
            <td>${user.telefono || 'N/A'}</td>
            <td><span class="badge ${user.activo ? 'badge-activo' : 'badge-inactivo'}">${user.activo ? 'Activo' : 'Inactivo'}</span></td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon edit" onclick='editUser(${JSON.stringify(user).replace(/'/g, "&apos;")})' title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon delete" onclick="deleteUser('${user.id}', '${user.nombre_completo}')" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      document.getElementById('usersTableBody').innerHTML = html || '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--navy-300);">No se encontraron usuarios</td></tr>';
    }

    function getRoleBadge(rol) {
      const badges = {
        'administrador': { class: 'badge-admin', text: 'Administrador' },
        'tecnico_audiovisual': { class: 'badge-audiovisual', text: 'Téc. Audiovisual' },
        'tecnico_integral': { class: 'badge-integral', text: 'Téc. Integral' },
        'tecnico_sistemas': { class: 'badge-sistemas', text: 'Téc. Sistemas' }
      };
      return badges[rol] || { class: 'badge-integral', text: rol };
    }

    function filterUsers() {
      renderUsersTable();
    }

    function openUserModal(mode, user = null) {
      currentEditId = user ? user.id : null;
      
      if (mode === 'new') {
        document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Nuevo Usuario';
        document.getElementById('userForm').reset();
        document.getElementById('userActive').checked = true;
        document.getElementById('passwordLabel').textContent = '*';
        document.getElementById('userPassword').required = true;
      } else {
        document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-edit"></i> Editar Usuario';
        document.getElementById('userId').value = user.id;
        document.getElementById('userFullName').value = user.nombre_completo;
        document.getElementById('userUsername').value = user.nombre_usuario;
        document.getElementById('userEmail').value = user.correo;
        document.getElementById('userRole').value = user.rol;
        document.getElementById('userPhone').value = user.telefono || '';
        document.getElementById('userCargo').value = user.cargo || '';
        document.getElementById('userActive').checked = user.activo;
        document.getElementById('passwordLabel').textContent = '(Opcional)';
        document.getElementById('userPassword').required = false;
      }
      
      document.getElementById('userModal').classList.add('active');
    }

    function closeUserModal() {
      document.getElementById('userModal').classList.remove('active');
      currentEditId = null;
    }

    function editUser(user) {
      openUserModal('edit', user);
    }

    function saveUser() {
      const id = document.getElementById('userId').value;
      const fullName = document.getElementById('userFullName').value;
      const username = document.getElementById('userUsername').value;
      const email = document.getElementById('userEmail').value;
      const rol = document.getElementById('userRole').value;
      const phone = document.getElementById('userPhone').value;
      const cargo = document.getElementById('userCargo').value;
      const password = document.getElementById('userPassword').value;
      const active = document.getElementById('userActive').checked;

      if (!fullName || !username || !email || !rol || !area) {
        Swal.fire({
          icon: 'warning',
          title: 'Campos incompletos',
          text: 'Por favor complete todos los campos obligatorios',
          background: 'var(--navy-800)',
          color: 'white',
          confirmButtonColor: 'var(--warning)'
        });
        return;
      }

      const now = new Date().toISOString();
      const specialty = getSpecialtyFromRole(rol);

      if (id) {
        // Edit existing user
        const userIndex = DATABASE.usuarios.findIndex(u => u.id === id);
        if (userIndex !== -1) {
          DATABASE.usuarios[userIndex] = {
            ...DATABASE.usuarios[userIndex],
            nombre_completo: fullName,
            nombre_usuario: username,
            correo: email,
            rol: rol,
            cargo: cargo,
            especialidad: specialty,
            telefono: phone,
            activo: active,
            updated_at: now
          };
          if (password) {
            DATABASE.usuarios[userIndex].password = password;
          }
        }
      } else {
        // Create new user
        const newId = `USR-${String(DATABASE.usuarios.length + 1).padStart(3, '0')}`;
        DATABASE.usuarios.push({
          id: newId,
          nombre_completo: fullName,
          nombre_usuario: username,
          correo: email,
          password: password,
          password_hash: `$2b$10$${btoa(password)}...`,
          rol: rol,
          cargo: cargo,
          especialidad: specialty,
          telefono: phone,
          foto_perfil: null,
          activo: active,
          forzar_cambio_password: false,
          intentos_fallidos: 0,
          bloqueado: false,
          fecha_registro: now,
          ultimo_acceso: null,
          created_at: now,
          updated_at: now
        });
      }

      Swal.fire({
        icon: 'success',
        title: id ? 'Usuario actualizado' : 'Usuario creado',
        text: 'Los cambios se han guardado correctamente',
        background: 'var(--navy-800)',
        color: 'white',
        confirmButtonColor: 'var(--success)',
        timer: 2000
      });

      closeUserModal();
      renderUsersTable();
      loadDashboard();
    }

    function getSpecialtyFromRole(rol) {
      const specialtyMap = {
        'administrador': 'gestion_integral',
        'tecnico_audiovisual': 'audiovisual',
        'tecnico_integral': 'integral_general',
        'tecnico_sistemas': 'sistemas_esenciales'
      };
      return specialtyMap[rol] || 'integral_general';
    }

    function deleteUser(userId, userName) {
      Swal.fire({
        title: '¿Eliminar usuario?',
        html: `<p style="color: var(--navy-300);">¿Estás seguro de que deseas eliminar a <strong>${userName}</strong>?</p><p style="color: var(--danger); margin-top: 10px;">Esta acción no se puede deshacer.</p>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--danger)',
        cancelButtonColor: 'var(--navy-600)',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        background: 'var(--navy-800)',
        color: 'white'
      }).then((result) => {
        if (result.isConfirmed) {
          DATABASE.usuarios = DATABASE.usuarios.filter(u => u.id !== userId);
          renderUsersTable();
          loadDashboard();
          Swal.fire({
            icon: 'success',
            title: 'Usuario eliminado',
            text: 'El usuario ha sido eliminado correctamente',
            background: 'var(--navy-800)',
            color: 'white',
            confirmButtonColor: 'var(--success)',
            timer: 2000
          });
        }
      });
    }

    // ACTIVITIES FUNCTIONS
    function loadActivities() {
      renderActivitiesTable();
    }

    function renderActivitiesTable() {
      const searchTerm = document.getElementById('searchActivities')?.value.toLowerCase() || '';
      const filteredActivities = DATABASE.actividades.filter(act =>
        act.titulo.toLowerCase().includes(searchTerm) ||
        act.descripcion.toLowerCase().includes(searchTerm)
      );

      let html = '';
      filteredActivities.forEach(act => {
        const user = DATABASE.usuarios.find(u => u.id === act.usuario_id);
        const categoria = DATABASE.categorias_mantenimiento.find(c => c.id === act.categoria_id);
        const hasEvidence = act.evidencias && act.evidencias.length > 0;

        html += `
          <tr>
            <td>
              <strong style="color: white;">${act.titulo}</strong>
              <p style="font-size: 13px; color: var(--navy-300); margin-top: 5px;">${act.lugar || 'Sin ubicación'}</p>
            </td>
            <td>${user ? user.nombre_completo : 'N/A'}</td>
            <td>${categoria ? categoria.nombre : 'N/A'}</td>
            <td>${act.fecha_actividad}</td>
            <td><span class="badge badge-${act.estado}">${act.estado}</span></td>
            <td style="text-align: center;">
              ${hasEvidence ? '<i class="fas fa-camera" style="color: var(--success);"></i>' : '<i class="fas fa-camera" style="color: var(--navy-500);"></i>'}
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon edit" onclick='editActivity(${JSON.stringify(act).replace(/'/g, "&apos;")})' title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon delete" onclick="deleteActivity('${act.id}', '${act.titulo}')" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      document.getElementById('activitiesTableBody').innerHTML = html || '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--navy-300);">No se encontraron actividades</td></tr>';
    }

    function filterActivities() {
      renderActivitiesTable();
    }

    function openActivityModal(mode, activity = null) {
      currentEditId = activity ? activity.id : null;
      uploadedImage = null;
      
      if (mode === 'new') {
        document.getElementById('activityModalTitle').innerHTML = '<i class="fas fa-plus"></i> Nueva Actividad';
        document.getElementById('activityForm').reset();
        document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('imagePreview').classList.remove('active');
      } else {
        document.getElementById('activityModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Actividad';
        document.getElementById('activityId').value = activity.id;
        document.getElementById('activityTitle').value = activity.titulo;
        document.getElementById('activityDescription').value = activity.descripcion;
        document.getElementById('activityUser').value = activity.usuario_id;
        document.getElementById('activityCategory').value = activity.categoria_id;
        document.getElementById('activityType').value = activity.tipo_mantenimiento_id;
        document.getElementById('activityArea').value = activity.area_id;
        document.getElementById('activityDate').value = activity.fecha_actividad;
        document.getElementById('activityDuration').value = activity.duracion_horas;
        document.getElementById('activityLocation').value = activity.lugar || '';
        document.getElementById('activityStatus').value = activity.estado;
        document.getElementById('activityPriority').value = activity.prioridad;
        document.getElementById('activityObservation').value = activity.observacion_supervisor || '';
        document.getElementById('imagePreview').classList.remove('active');
      }
      
      document.getElementById('activityModal').classList.add('active');
    }

    function closeActivityModal() {
      document.getElementById('activityModal').classList.remove('active');
      currentEditId = null;
      uploadedImage = null;
    }

    function editActivity(activity) {
      openActivityModal('edit', activity);
    }

    function previewImage(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImg').src = e.target.result;
          document.getElementById('imagePreview').classList.add('active');
          uploadedImage = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function saveActivity() {
      const id = document.getElementById('activityId').value;
      const titulo = document.getElementById('activityTitle').value;
      const descripcion = document.getElementById('activityDescription').value;
      const usuario = document.getElementById('activityUser').value;
      const categoria = document.getElementById('activityCategory').value;
      const tipo = document.getElementById('activityType').value;
      const area = document.getElementById('activityArea').value;
      const fecha = document.getElementById('activityDate').value;
      const duracion = parseFloat(document.getElementById('activityDuration').value);
      const lugar = document.getElementById('activityLocation').value;
      const estado = document.getElementById('activityStatus').value;
      const prioridad = document.getElementById('activityPriority').value;
      const observacion = document.getElementById('activityObservation').value;

      if (!titulo || !descripcion || !usuario || !categoria || !tipo || !area || !fecha || !duracion) {
        Swal.fire({
          icon: 'warning',
          title: 'Campos incompletos',
          text: 'Por favor complete todos los campos obligatorios',
          background: 'var(--navy-800)',
          color: 'white',
          confirmButtonColor: 'var(--warning)'
        });
        return;
      }

      const now = new Date().toISOString();

      if (id) {
        // Edit existing activity
        const actIndex = DATABASE.actividades.findIndex(a => a.id === id);
        if (actIndex !== -1) {
          DATABASE.actividades[actIndex] = {
            ...DATABASE.actividades[actIndex],
            titulo: titulo,
            descripcion: descripcion,
            usuario_id: usuario,
            categoria_id: categoria,
            tipo_mantenimiento_id: tipo,
            area_id: area,
            fecha_actividad: fecha,
            duracion_horas: duracion,
            lugar: lugar,
            estado: estado,
            prioridad: prioridad,
            observacion_supervisor: observacion,
            supervisor_id: currentAdmin.id,
            updated_at: now
          };

          // Add evidence if uploaded
          if (uploadedImage) {
            const evidenceId = `EVI-${String(DATABASE.evidencias?.length || 0 + 1).padStart(3, '0')}`;
            if (!DATABASE.actividades[actIndex].evidencias) {
              DATABASE.actividades[actIndex].evidencias = [];
            }
            DATABASE.actividades[actIndex].evidencias.push(evidenceId);
          }
        }
      } else {
        // Create new activity
        const newId = `ACT-${String(DATABASE.actividades.length + 1).padStart(3, '0')}`;
        const evidencias = [];
        
        if (uploadedImage) {
          const evidenceId = `EVI-${String(DATABASE.evidencias?.length || 0 + 1).padStart(3, '0')}`;
          evidencias.push(evidenceId);
        }

        DATABASE.actividades.push({
          id: newId,
          titulo: titulo,
          descripcion: descripcion,
          tarea_id: null,
          categoria_id: categoria,
          tipo_mantenimiento_id: tipo,
          area_id: area,
          usuario_id: usuario,
          fecha_actividad: fecha,
          hora_inicio: "08:00",
          hora_fin: "10:00",
          duracion_horas: duracion,
          lugar: lugar,
          estado: estado,
          prioridad: prioridad,
          materiales_usados: [],
          observacion_empleado: null,
          observacion_supervisor: observacion,
          supervisor_id: currentAdmin.id,
          fecha_envio: estado === 'enviado' || estado === 'aprobado' ? now : null,
          fecha_revision: estado === 'aprobado' ? now : null,
          evidencias: evidencias,
          created_at: now,
          updated_at: now
        });
      }

      Swal.fire({
        icon: 'success',
        title: id ? 'Actividad actualizada' : 'Actividad creada',
        text: 'Los cambios se han guardado correctamente',
        background: 'var(--navy-800)',
        color: 'white',
        confirmButtonColor: 'var(--success)',
        timer: 2000
      });

      closeActivityModal();
      renderActivitiesTable();
      loadDashboard();
    }

    function deleteActivity(activityId, activityTitle) {
      Swal.fire({
        title: '¿Eliminar actividad?',
        html: `<p style="color: var(--navy-300);">¿Estás seguro de que deseas eliminar "<strong>${activityTitle}</strong>"?</p><p style="color: var(--danger); margin-top: 10px;">Esta acción no se puede deshacer.</p>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--danger)',
        cancelButtonColor: 'var(--navy-600)',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        background: 'var(--navy-800)',
        color: 'white'
      }).then((result) => {
        if (result.isConfirmed) {
          DATABASE.actividades = DATABASE.actividades.filter(a => a.id !== activityId);
          renderActivitiesTable();
          loadDashboard();
          Swal.fire({
            icon: 'success',
            title: 'Actividad eliminada',
            text: 'La actividad ha sido eliminada correctamente',
            background: 'var(--navy-800)',
            color: 'white',
            confirmButtonColor: 'var(--success)',
            timer: 2000
          });
        }
      });
    }

    function exportToExcel() {
      const activitiesToExport = DATABASE.actividades.map(act => {
        const user = DATABASE.usuarios.find(u => u.id === act.usuario_id);
        const categoria = DATABASE.categorias_mantenimiento.find(c => c.id === act.categoria_id);
        const tipo = DATABASE.tipos_mantenimiento.find(t => t.id === act.tipo_mantenimiento_id);
        const area = DATABASE.areas.find(a => a.id === act.area_id);

        return {
          'ID': act.id,
          'Título': act.titulo,
          'Descripción': act.descripcion,
          'Usuario': user ? user.nombre_completo : 'N/A',
          'Categoría': categoria ? categoria.nombre : 'N/A',
          'Tipo Mantenimiento': tipo ? tipo.nombre : 'N/A',
          'Área': area ? area.nombre : 'N/A',
          'Fecha': act.fecha_actividad,
          'Duración (hrs)': act.duracion_horas,
          'Lugar': act.lugar || 'N/A',
          'Estado': act.estado,
          'Prioridad': act.prioridad,
          'Evidencias': act.evidencias && act.evidencias.length > 0 ? 'Sí' : 'No',
          'Observación': act.observacion_supervisor || 'N/A',
          'Fecha Creación': act.created_at
        };
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(activitiesToExport);
      
      // Auto-size columns
      const colWidths = [
        { wch: 10 }, // ID
        { wch: 30 }, // Título
        { wch: 40 }, // Descripción
        { wch: 25 }, // Usuario
        { wch: 25 }, // Categoría
        { wch: 20 }, // Tipo
        { wch: 25 }, // Área
        { wch: 12 }, // Fecha
        { wch: 12 }, // Duración
        { wch: 25 }, // Lugar
        { wch: 12 }, // Estado
        { wch: 12 }, // Prioridad
        { wch: 10 }, // Evidencias
        { wch: 30 }, // Observación
        { wch: 20 }  // Fecha Creación
      ];
      ws['!cols'] = colWidths;

      XLSX.utils.book_append_sheet(wb, ws, 'Actividades');
      
      const fileName = `Actividades_Campus_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Swal.fire({
        icon: 'success',
        title: 'Exportación exitosa',
        text: `El archivo ${fileName} ha sido descargado`,
        background: 'var(--navy-800)',
        color: 'white',
        confirmButtonColor: 'var(--success)',
        timer: 2000
      });
    }

    // STATISTICS FUNCTIONS
    function loadStatistics() {
      const totalUsers = DATABASE.usuarios.length;
      const totalActivities = DATABASE.actividades.length;
      const activeUsers = DATABASE.usuarios.filter(u => u.activo).length;
      const avgDuration = DATABASE.actividades.reduce((sum, a) => sum + a.duracion_horas, 0) / totalActivities || 0;

      document.getElementById('detailedStats').innerHTML = `
        <div class="stat-card">
          <div class="stat-card-header">
            <div>
              <div class="stat-card-value">${totalUsers}</div>
              <div class="stat-card-label">Total Usuarios</div>
            </div>
            <div class="stat-card-icon">
              <i class="fas fa-users"></i>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div>
              <div class="stat-card-value">${activeUsers}</div>
              <div class="stat-card-label">Usuarios Activos</div>
            </div>
            <div class="stat-card-icon">
              <i class="fas fa-user-check"></i>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div>
              <div class="stat-card-value">${totalActivities}</div>
              <div class="stat-card-label">Total Actividades</div>
            </div>
            <div class="stat-card-icon">
              <i class="fas fa-clipboard-list"></i>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div>
              <div class="stat-card-value">${avgDuration.toFixed(1)}h</div>
              <div class="stat-card-label">Duración Promedio</div>
            </div>
            <div class="stat-card-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
        </div>
      `;

      // Category distribution
      const categoryCounts = {};
      DATABASE.actividades.forEach(act => {
        const cat = DATABASE.categorias_mantenimiento.find(c => c.id === act.categoria_id);
        if (cat) {
          if (!categoryCounts[cat.nombre]) {
            categoryCounts[cat.nombre] = { count: 0, color: cat.color };
          }
          categoryCounts[cat.nombre].count++;
        }
      });

      let distHtml = '';
      for (const [category, data] of Object.entries(categoryCounts)) {
        const percentage = Math.round((data.count / totalActivities) * 100);
        distHtml += `
          <div style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: white; font-weight: 600;">${category}</span>
              <span style="color: var(--navy-300); font-weight: 600;">${data.count} (${percentage}%)</span>
            </div>
            <div style="width: 100%; height: 12px; background: rgba(15, 23, 42, 0.5); border-radius: 10px; overflow: hidden; border: 1px solid rgba(59, 130, 246, 0.2);">
              <div style="width: ${percentage}%; height: 100%; background: ${data.color}; border-radius: 10px; transition: width 0.5s ease;"></div>
            </div>
          </div>
        `;
      }

      document.getElementById('categoryDistribution').innerHTML = distHtml;
    }

    function logout() {
      Swal.fire({
        title: '¿Cerrar sesión?',
        html: '<p style="color: var(--navy-300);">¿Estás seguro de que deseas salir del panel administrativo?</p>',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: 'var(--danger)',
        cancelButtonColor: 'var(--navy-600)',
        confirmButtonText: 'Sí, cerrar sesión',
        cancelButtonText: 'Cancelar',
        background: 'var(--navy-800)',
        color: 'white'
      }).then((result) => {
        if (result.isConfirmed) {
          // Limpiar todas las sesiones
          sessionStorage.removeItem('session_SAC');
          localStorage.removeItem('session_SAC_permanent');
          
          // Guardar motivo de logout
          localStorage.setItem('logout_motivo', 'manual');
          
          // Prevenir que el navegador vuelva a esta página
          window.location.replace('index.html?logout=1');
        }
      });
    }
  </script>
</body>
</html>
