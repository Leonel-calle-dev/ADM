<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Restablecer Contraseña - Sistema de Gestión del Campus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, rgba(0,0,0,0.75), rgba(0,0,0,0.85)),
                  url("https://lh3.googleusercontent.com/fife/ALs6j_HMdLowsBDyMH08lSYMP526rzMIMN9wt7jXZZFf8jM6CZZH1ivkEyLEyCmVha1VedXa8c75Sk3RqnW-6Sm-IBSwEOtoJQvc7Esu-RzT0LJ3FuXPBkivVzwM9Q2748XvBIw8aanjN6fyfQeGFhRXoLuZOwf0tpSaOYCECdmCfEk2a6R4-802OCn4S7i1YMb5hM-qd9UdOu47PFFPL06yinWib4KhsmNfD_W7TFo83U_OGEuJZzPbcT7LkKZXC3b_2VgEMe2JS6o7kcb2ry6oRIbOWzqOlFjk61Tlmd-32jBuQWZrn6sy_UJ0a69eYe9uibqkE6pmW9PHP3Gi0BHBTPnvO92uOBJVCWXHOBIegNzBA2uGcx_m-xmDwX4XMuxFK2cqRx3X2vt1E8ElJ4RlFPczag8nWfdC6PtqPJEQU2l7rymXzhiIaE98Q6lyDwzmZIROcddNduoQAljarqmhC_tDzGdFLQATfwVtwFoP1lsJTz_02g2LX8nCAum9oPnR1E_Z5eDu90XBnq_-bvu3dozD7ohKBenK_bmPqCLcbfVkr4TWbg65jy2smsQ6cxqg0lIIFAAwqvU0SZLA0U-hNIE7QGKkwsTLWRvBIXjH4PnGViJf0JokDgRQ3t5FNf7jo3XtbhIXUMGdLOEHmjSqxk_DXinm71dTQH2IdEIkVX_uLFuQJ0h7IamAYO1AE6gcJSbJO08b0sDeAzLIILseimolgNrLHJGmCy3O3SzsolvitUkL8vrYmSRCHRSBZyntsqnhg5VO4DBwc8oBJYUtz2deMX53XJ43Uiui2E4E5V9A8UqL6raacHQfQqbDzVnmOymYwjy6UEmOHNyshpRuFHoQSmTPoDC-OlPvIRF3OUIhnpyaP628spE74uE5inv689gT8ZWIHhRi2Jdj_JJmCcA3e5Xs1ODHF0OHaj7gy4znKZbz-XL6xeR4mETQe8BHzf2GHQDbgDIgieT84MlYNEP_OpzGaKmrL3fpNpDqGQ6IOe4OFzy3uf8d-chcRjr--8Fb9IueJaEzlmJFbor54oJNATKK9J6K6MI2WPmzh48-pfsWLhKNfffOwyFpi6EzUTCE5WTHLGNiYj_aHh3pyN4_KDZlBe8kBsfKwiYyBYwHl_9-B25vDZgZ50kzyNPe9JVpkxW2FphapRaFucNkbfJXsxTXfIS-cuCU-3K_kcuNw0iEAA9HDy6vSAiXHGSX5KWFhpaGwtAoAbmZDf9Hp99elOQ2y3r2bf9lE56OPPvtyK5gvQHRB8U89QxR50DL-9nvYKxUV-3am5qYND1_LXrklWT5fxM9DNIUCbDTjTcl4wMtiRWNmdHTlEW8cspHMrnwmLLLTuEaOgFSDU95aqhUJczV0cnZIhfZ1qM6Ag-FYWOp79RUG9d4lXPWATmtD1G5uIgLqxO8m-3ggULYa3ul9iJ0G2HgDbTR0lAu0m8c1uN-GHCpn1cpwcGPh7e5lf-K9VUBRCEG7Fy1NxEgyuDO4FQZhhxEK3fB5KoEiA2vwN3JaKyfgb7jjaaV_P7nAk_x1f95XwKIjm0zAct0j69srXvRFPhmKjEpTgIEOEs-AydSuz8nkzjJdGTkLznFA_0Lb67owlRMIyZYen5-sBMOkiJd1VVwdURGXbNSmYsA3QbAWF4UqRXHEbno1TgH9eGG8AXXHqsIsY0GWNyj5LAMwDBIa6bRLXjSbKM4T13rmEBG8YWvipHmBEZGbhWV3BvP2ho_m_dYBrw07YU=w1910-h922?auditContext=prefetch") no-repeat center center/cover;
      background-attachment: fixed;
      padding: 20px;
    }

    .reset-container {
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(12px);
      padding: 45px 40px;
      border-radius: 24px;
      width: 100%;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 10px 35px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.18);
      animation: fadeIn 0.8s ease-out;
      color: #fff;
      position: relative;
      overflow: hidden;
    }

    .reset-container::before {
      content: '';
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(0,119,255,0.15) 0%, rgba(0,225,255,0.08) 35%, transparent 70%);
      z-index: -1;
      animation: rotate 15s linear infinite;
    }

    @keyframes rotate { 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    .reset-container img {
      width: 120px;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

    .reset-container h2 {
      font-size: 1.9rem;
      font-weight: 700;
      margin-bottom: 6px;
      position: relative;
      display: inline-block;
    }

    .reset-container h2::after {
      content: '';
      position: absolute;
      bottom: -8px; left: 50%;
      transform: translateX(-50%);
      width: 60%; height: 3px;
      background: linear-gradient(90deg, transparent, #00e1ff, transparent);
      border-radius: 3px;
    }

    .sistema-badge {
      display: inline-block;
      background: rgba(0,119,255,0.2);
      border: 1px solid rgba(0,225,255,0.3);
      color: #00e1ff;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 4px 12px;
      border-radius: 100px;
      margin: 14px 0 24px;
    }

    /* ── Pasos ── */
    .steps {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      margin-bottom: 28px;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .step-circle {
      width: 36px; height: 36px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 14px;
      background: rgba(255,255,255,0.15);
      border: 2px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.5);
      transition: all 0.4s;
    }

    .step-label {
      font-size: 10px;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.4s;
    }

    .step.active .step-circle {
      background: linear-gradient(135deg, #0077ff, #00e1ff);
      border-color: #00e1ff;
      color: white;
      box-shadow: 0 0 15px rgba(0,225,255,0.5);
    }

    .step.active .step-label { color: #00e1ff; }

    .step.done .step-circle {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    .step.done .step-label { color: #10b981; }

    .step-line {
      width: 40px; height: 2px;
      background: rgba(255,255,255,0.15);
      margin-bottom: 20px;
      transition: background 0.4s;
    }

    .step-line.done { background: #10b981; }

    /* ── Status ── */
    .status-card {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: left;
    }

    .status-card.loading { background: rgba(0,119,255,0.15); border: 1px solid rgba(0,119,255,0.3); color: #60a5fa; }
    .status-card.success { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); color: #6ee7b7; }
    .status-card.error   { background: rgba(220,53,69,0.15);  border: 1px solid rgba(220,53,69,0.3);  color: #fca5a5; }

    /* ── Inputs ── */
    .input-group { margin-bottom: 20px; text-align: left; }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #fff;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .input-wrapper { position: relative; }

    .input-group input {
      width: 100%;
      padding: 15px 50px 15px 50px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 14px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 1rem;
      font-family: "Poppins", sans-serif;
      transition: all 0.3s;
    }

    .input-group input::placeholder { color: rgba(255,255,255,0.45); }

    .input-group input:focus {
      outline: none;
      border-color: #00e1ff;
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 20px rgba(0,225,255,0.3);
    }

    .input-icon {
      position: absolute;
      left: 18px; top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,0.5);
      font-size: 16px;
    }

    .toggle-password {
      position: absolute;
      right: 18px; top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: rgba(255,255,255,0.5);
      background: none;
      border: none;
      font-size: 16px;
      transition: color 0.3s;
      display: flex; align-items: center; justify-content: center;
    }

    .toggle-password:hover { color: #00e1ff; }

    /* ── Requisitos ── */
    .req-box {
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 20px;
      text-align: left;
    }

    .req-box h4 { color: #00e1ff; font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; }

    .req-item {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 6px;
      transition: color 0.3s;
    }

    .req-item i { font-size: 12px; color: rgba(255,255,255,0.25); transition: color 0.3s; }
    .req-item.ok { color: rgba(255,255,255,0.9); }
    .req-item.ok i { color: #10b981; }

    /* ── Barra fortaleza ── */
    .strength-bar {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }

    .strength-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.4s, background 0.4s;
      width: 0%;
    }

    /* ── Botón ── */
    .btn-reset {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #0077ff, #00e1ff);
      color: #fff;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.5px;
      box-shadow: 0 8px 20px rgba(0,119,255,0.4);
      font-family: "Poppins", sans-serif;
      position: relative;
      overflow: hidden;
    }

    .btn-reset:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(0,119,255,0.5);
    }

    .btn-reset:disabled { background: linear-gradient(135deg, #5a98ff, #7eb3ff); cursor: not-allowed; }

    .btn-reset.loading::after {
      content: '';
      position: absolute;
      left: 15px; top: 50%;
      transform: translateY(-50%);
      width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }

    /* ── Panel éxito ── */
    .success-panel { display: none; padding: 10px 0; }
    .success-icon { font-size: 3rem; margin-bottom: 12px; }

    /* ── Link ── */
    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #00e1ff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .back-link:hover { color: #00b8cc; text-decoration: underline; }

    @media (max-width: 480px) {
      .reset-container { padding: 30px 25px; }
      .reset-container h2 { font-size: 1.6rem; }
    }
  </style>
</head>
<body>
  <div class="reset-container">

    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/48/Escudo_UAP.png/800px-Escudo_UAP.png" alt="Logo Campus">

    <h2>Restablecer Contraseña</h2>
    <div class="sistema-badge">
      <i class="fas fa-shield-alt" style="margin-right:5px;font-size:10px;"></i>
      Sistema de Gestión del Campus
    </div>

    <!-- Pasos -->
    <div class="steps">
      <div class="step active" id="step1">
        <div class="step-circle">1</div>
        <div class="step-label">Verificar</div>
      </div>
      <div class="step-line" id="line1"></div>
      <div class="step" id="step2">
        <div class="step-circle">2</div>
        <div class="step-label">Nueva clave</div>
      </div>
      <div class="step-line" id="line2"></div>
      <div class="step" id="step3">
        <div class="step-circle">3</div>
        <div class="step-label">Listo</div>
      </div>
    </div>

    <!-- Status -->
    <div class="status-card loading" id="statusCard">
      <i class="fas fa-spinner fa-spin"></i>
      <span id="statusMsg">Verificando enlace de recuperación...</span>
    </div>

    <!-- Formulario nueva contraseña -->
    <div id="resetForm" style="display:none">
      <div class="req-box">
        <h4><i class="fas fa-shield-alt" style="margin-right:6px;"></i>Requisitos</h4>
        <div class="req-item" id="req-len"><i class="fas fa-circle"></i> Mínimo 8 caracteres</div>
        <div class="req-item" id="req-upper"><i class="fas fa-circle"></i> Al menos una mayúscula</div>
        <div class="req-item" id="req-num"><i class="fas fa-circle"></i> Al menos un número</div>
        <div class="req-item" id="req-special"><i class="fas fa-circle"></i> Al menos un carácter especial</div>
        <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
      </div>

      <div class="input-group">
        <label><i class="fas fa-lock" style="margin-right:6px;"></i>Nueva Contraseña</label>
        <div class="input-wrapper">
          <i class="input-icon fas fa-lock"></i>
          <input type="password" id="newPassword" placeholder="Ingresa tu nueva contraseña">
          <button type="button" class="toggle-password" id="toggleNew"><i class="fas fa-eye"></i></button>
        </div>
      </div>

      <div class="input-group">
        <label><i class="fas fa-lock" style="margin-right:6px;"></i>Confirmar Contraseña</label>
        <div class="input-wrapper">
          <i class="input-icon fas fa-lock"></i>
          <input type="password" id="confirmPassword" placeholder="Confirma tu contraseña">
          <button type="button" class="toggle-password" id="toggleConfirm"><i class="fas fa-eye"></i></button>
        </div>
      </div>

      <button class="btn-reset" id="btnReset" onclick="confirmarReset()">
        <i class="fas fa-key" style="margin-right:8px;"></i>Restablecer Contraseña
      </button>
    </div>

    <!-- Panel éxito -->
    <div class="success-panel" id="successPanel">
      <div class="success-icon">✅</div>
      <h3 style="color:#6ee7b7;margin-bottom:8px;">¡Contraseña actualizada!</h3>
      <p style="color:rgba(255,255,255,0.75);font-size:14px;margin-bottom:20px;">
        Tu contraseña fue restablecida correctamente.<br>Ya puedes iniciar sesión.
      </p>
      <button class="btn-reset" onclick="window.location.href='index.html'">
        <i class="fas fa-sign-in-alt" style="margin-right:8px;"></i>Ir al Login
      </button>
    </div>

    <a href="index.html" class="back-link">
      <i class="fas fa-arrow-left" style="margin-right:6px;"></i>Volver al Login
    </a>

  </div>

<!-- ===================== FIREBASE ===================== -->
<script type="module">
  import { auth } from "./firebase-config.js";
  import {
    verifyPasswordResetCode,
    confirmPasswordReset
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  let oobCode = null;

  // ─── Helpers UI ──────────────────────────────────────────
  function setStatus(msg, tipo = "loading") {
    const card = document.getElementById("statusCard");
    const span = document.getElementById("statusMsg");
    card.className = `status-card ${tipo}`;
    const icons = { loading: "fas fa-spinner fa-spin", success: "fas fa-check-circle", error: "fas fa-times-circle" };
    card.querySelector("i").className = icons[tipo] || icons.loading;
    span.textContent = msg;
  }

  function setStep(n) {
    for (let i = 1; i <= 3; i++) {
      const s = document.getElementById(`step${i}`);
      if (i < n) {
        s.className = "step done";
        if (i <= 2) document.getElementById(`line${i}`).className = "step-line done";
      } else if (i === n) {
        s.className = "step active";
      } else {
        s.className = "step";
      }
    }
  }

  // ─── Toggle contraseña ────────────────────────────────────
  function setupToggle(btnId, inputId) {
    document.getElementById(btnId).addEventListener("click", function () {
      const inp = document.getElementById(inputId);
      const isPass = inp.type === "password";
      inp.type = isPass ? "text" : "password";
      this.innerHTML = isPass ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
    });
  }

  setupToggle("toggleNew", "newPassword");
  setupToggle("toggleConfirm", "confirmPassword");

  // ─── Validación en tiempo real ────────────────────────────
  document.getElementById("newPassword").addEventListener("input", function () {
    const v = this.value;
    const checks = {
      "req-len":     v.length >= 8,
      "req-upper":   /[A-Z]/.test(v),
      "req-num":     /[0-9]/.test(v),
      "req-special": /[!@#$%^&*(),.?":{}|<>_\-]/.test(v)
    };
    let score = 0;
    for (const [id, ok] of Object.entries(checks)) {
      const el = document.getElementById(id);
      el.className = "req-item" + (ok ? " ok" : "");
      el.querySelector("i").className = ok ? "fas fa-check-circle" : "fas fa-circle";
      if (ok) score++;
    }
    const pct = (score / 4) * 100;
    const colors = ["#ef4444", "#f59e0b", "#3b82f6", "#10b981"];
    const fill = document.getElementById("strengthFill");
    fill.style.width = pct + "%";
    fill.style.background = colors[score - 1] || "#ef4444";
  });

  // ─── Confirmar reset (expuesto globalmente) ───────────────
  window.confirmarReset = async function () {
    const newPwd  = document.getElementById("newPassword").value;
    const confPwd = document.getElementById("confirmPassword").value;

    if (newPwd !== confPwd) {
      Swal.fire({ icon: "error", title: "No coinciden", text: "Las contraseñas no son iguales.", confirmButtonColor: "#dc3545" });
      return;
    }

    const ok = newPwd.length >= 8 && /[A-Z]/.test(newPwd) && /[0-9]/.test(newPwd) && /[!@#$%^&*(),.?":{}|<>_\-]/.test(newPwd);
    if (!ok) {
      Swal.fire({ icon: "error", title: "Contraseña débil", text: "La contraseña no cumple los requisitos.", confirmButtonColor: "#dc3545" });
      return;
    }

    const btn = document.getElementById("btnReset");
    btn.disabled = true;
    btn.classList.add("loading");
    btn.innerHTML = '<span style="opacity:0">Guardando...</span>';

    try {
      await confirmPasswordReset(auth, oobCode, newPwd);

      // Éxito
      setStep(3);
      setStatus("¡Contraseña restablecida correctamente!", "success");
      document.getElementById("resetForm").style.display  = "none";
      document.getElementById("successPanel").style.display = "block";

      // Redirigir automáticamente tras 4s
      setTimeout(() => { window.location.href = "index.html"; }, 4000);

    } catch (err) {
      btn.disabled = false;
      btn.classList.remove("loading");
      btn.innerHTML = '<i class="fas fa-key" style="margin-right:8px;"></i>Restablecer Contraseña';

      const msgs = {
        "auth/expired-action-code": "El enlace ha expirado. Solicita uno nuevo.",
        "auth/invalid-action-code": "El enlace es inválido o ya fue usado.",
        "auth/weak-password":       "La contraseña es demasiado débil.",
        "auth/user-disabled":       "Esta cuenta ha sido desactivada."
      };
      Swal.fire({
        icon: "error",
        title: "Error",
        text: msgs[err.code] || "No se pudo restablecer la contraseña.",
        confirmButtonColor: "#dc3545"
      });
    }
  };

  // ─── INICIALIZACIÓN ───────────────────────────────────────
  window.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(window.location.search);
    const mode   = params.get("mode");
    oobCode      = params.get("oobCode");

    // Si no es un enlace de reset válido
    if (mode !== "resetPassword" || !oobCode) {
      setStatus("Enlace inválido o incompleto.", "error");
      setTimeout(() => { window.location.href = "index.html"; }, 3000);
      return;
    }

    // Verificar que el código sea válido
    try {
      await verifyPasswordResetCode(auth, oobCode);
      setStep(2);
      setStatus("Enlace válido. Define tu nueva contraseña.", "success");
      document.getElementById("resetForm").style.display = "block";
    } catch (err) {
      const msgs = {
        "auth/expired-action-code": "El enlace ha expirado. Solicita un nuevo correo de recuperación.",
        "auth/invalid-action-code": "El enlace ya fue utilizado o no es válido."
      };
      setStatus(msgs[err.code] || "Enlace inválido.", "error");
      Swal.fire({
        icon: "error",
        title: "Enlace inválido",
        text: msgs[err.code] || "El enlace de recuperación no es válido.",
        confirmButtonColor: "#dc3545"
      }).then(() => { window.location.href = "index.html"; });
    }
  });
</script>
</body>
</html>
